// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// NOMENCLADORES DINÁMICOS (TABLAS DE CATÁLOGO)
// ============================================

// Tipo de Venta (Both, Retail, Wholesale)
model SaleType {
  id        String   @id @default(uuid())
  slug      String   @unique // both, retail, wholesale api
  title     String // Both, Retail, Wholesale. 
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sale_types")
}

// Estado de Millaje (TMU, EML, Exempt, Actual)
model MileageStatus {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("mileage_statuses")
}

// Estado del Vehículo (In Inventory, Sold, Pending, etc.)
model VehicleStatus {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  vehicles Vehicle[]

  @@map("vehicle_statuses")
}

// Estado del Título (Received, Not Received, etc.)
model TitleStatus {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  titles Title[]

  @@map("title_statuses")
}

// Condición del Vehículo (Excellent, Very Good, Good, etc.)
model VehicleCondition {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  vehicles Vehicle[]

  @@map("vehicle_conditions")
}

// Marcas del Título (Clean, Salvage, Junk, etc.)
model BrandStatus {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  titles Title[]

  @@map("brand_statuses")
}

// Tipo de Vehículo (Auto, Truck, Motorcycle, etc.)
model VehicleType {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  vehicles Vehicle[]

  @@map("vehicle_types")
}

// Tipo de Carrocería (Sedan, Coupe, SUV, etc.)
model BodyType {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  vehicles Vehicle[]

  @@map("body_types")
}

// Tipo de Combustible (Gasoline, Diesel, Electric, etc.)
model FuelType {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  vehicles Vehicle[]

  @@map("fuel_types")
}

// Tipo de Tracción (FWD, RWD, AWD, 4WD)
model DriveType {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  vehicles Vehicle[]

  @@map("drive_types")
}

// Tipo de Transmisión (Automatic, Manual, CVT, etc.)
model TransmissionType {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  vehicles Vehicle[]

  @@map("transmission_types")
}

// Origen del Vehículo (Auction, Trade-In, Private Party, Dealer, etc.)
model VehicleSource {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  vehicles Vehicle[]

  @@map("vehicle_sources")
}

// Estado de Inspección (Passed, Failed, Pending, etc.)
model InspectionStatus {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("inspection_statuses")
}

// Tipo de Actividad (Note, Task, Call, Email, etc.)
model ActivityType {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("activity_types")
}

// Estado de Actividad (Created, Completed, Cancelled, etc.)
model ActivityStatus {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("activity_statuses")
}

// Rol de Usuario (Admin, Manager, Salesperson, etc.)
model UserRole {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_roles")
}

// Fuente de Lead (Lead Source - Social Media & Marketplaces)
model LeadSource {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("lead_sources")
}

// Tipo de Consulta (Inquiry Type)
model InquiryType {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("inquiry_types")
}

// Idioma Preferido (Preferred Language)
model PreferredLanguage {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  buyers Buyer[]

  @@map("preferred_languages")
}

// Método de Contacto (Contact Method)
model ContactMethod {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("contact_methods")
}

// Hora de Contacto (Contact Time)
model ContactTime {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("contact_times")
}

// Género (Gender)
model Gender {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  buyers Buyer[]

  @@map("genders")
}

// Tipo de ID (ID Type)
model IdType {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  buyers Buyer[]

  @@map("id_types")
}

// Estado del ID (ID State - US States)
model IdState {
  id        String   @id @default(uuid())
  slug      String   @unique // Código del estado (AL, AK, AZ, etc.)
  title     String // Nombre del estado
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  buyers Buyer[]

  @@map("id_states")
}

// Estado de Empleo (Employment Status)
model EmploymentStatus {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  buyers Buyer[]

  @@map("employment_statuses")
}

// Ocupación (Occupation)
model Occupation {
  id        String   @id @default(uuid())
  slug      String   @unique
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  buyers Buyer[]

  @@map("occupations")
}

// Estado del Deal (Deal Status)
model DealStatus {
  id        String   @id @default(uuid())
  slug      String   @unique // draft, pending, approved, funded, delivered, cancelled
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  deals Deal[]

  @@map("deal_statuses")
}

// Tipo de Financiamiento (Finance Type)
model FinanceType {
  id        String   @id @default(uuid())
  slug      String   @unique // cash, finance, lease
  title     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  deals Deal[]

  @@map("finance_types")
}

// ============================================
// JERARQUÍA DE VEHÍCULOS (Year → Make → Model → Trim)
// ============================================

// Año del Vehículo
model VehicleYear {
  id        String   @id @default(uuid())
  year      Int      @unique // 2020, 2021, 2022, etc.
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  makes VehicleMake[]

  @@index([year])
  @@map("vehicle_years")
}

// Marca del Vehículo (Make)
model VehicleMake {
  id     String @id @default(uuid())
  yearId String
  name   String // <filter using like operator>

  slug      String // ford, toyota, honda
  isActive  Boolean  @default(true) //<filter using equal operator>
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  year   VehicleYear    @relation(fields: [yearId], references: [id], onDelete: Cascade)
  models VehicleModel[]

  @@unique([yearId, slug])
  @@index([yearId])
  @@index([slug])
  @@map("vehicle_makes")
}

// Modelo del Vehículo (Model)
model VehicleModel {
  id        String   @id @default(uuid())
  makeId    String
  name      String // F-150, Camry, Accord, etc.
  slug      String // f-150, camry, accord
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  make  VehicleMake   @relation(fields: [makeId], references: [id], onDelete: Cascade)
  trims VehicleTrim[]

  @@unique([makeId, slug])
  @@index([makeId])
  @@index([slug])
  @@map("vehicle_models")
}

// Trim/Versión del Vehículo
model VehicleTrim {
  id        String   @id @default(uuid())
  modelId   String
  name      String // XLT, LE, EX, Sport, etc.
  slug      String // xlt, le, ex, sport
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  model VehicleModel @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@unique([modelId, slug])
  @@index([modelId])
  @@index([slug])
  @@map("vehicle_trims")
}

// ============================================
// MODELOS PRINCIPALES
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// ============================================
// BUYER - Solo datos personales básicos del comprador
// ============================================
model Buyer {
  id String @id @default(uuid())

  // Información Personal Básica
  firstName   String
  middleName  String?
  lastName    String
  suffix      String? // Jr., Sr., III, etc.
  dateOfBirth DateTime
  genderId    String?
  ssn         String? // Social Security Number (encriptado)
  itin        String? // Individual Taxpayer Identification Number (alternative to SSN)
  citizenship String? // US Citizen, Permanent Resident, Visa Holder, etc.

  // Relación con Gender
  gender Gender? @relation(fields: [genderId], references: [id])

  // Información de Contacto
  email               String
  phoneMain           String
  phoneSecondary      String?
  phoneMobile         String?
  preferredLanguageId String?

  // Relaciones de contacto
  preferredLanguage PreferredLanguage? @relation(fields: [preferredLanguageId], references: [id])

  // Dirección Actual
  currentAddress     String
  currentCity        String
  currentState       String
  currentZipCode     String
  currentCountry     String   @default("USA")
  yearsAtAddress     Int?
  monthsAtAddress    Int?
  housingStatus      String? // Own, Rent, Living with parents, etc.
  monthlyHousingCost Decimal? @db.Decimal(10, 2)

  // Dirección Anterior (si menos de 2 años en actual)
  previousAddress         String?
  previousCity            String?
  previousState           String?
  previousZipCode         String?
  previousCountry         String?
  yearsAtPreviousAddress  Int?
  monthsAtPreviousAddress Int?

  // Identificación
  idTypeId                 String?
  idNumber                 String?
  idStateId                String?
  idExpirationDate         DateTime?
  idIssueDate              DateTime?
  driversLicenseNumber     String?
  driversLicenseState      String?
  driversLicenseExpiration DateTime?

  // Relaciones de ID
  idType  IdType?  @relation(fields: [idTypeId], references: [id])
  idState IdState? @relation(fields: [idStateId], references: [id])

  // Empleo Actual
  employmentStatusId     String?
  currentEmployer        String?
  employerPhone          String?
  occupationId           String?
  jobTitle               String?
  employerAddress        String?
  employerCity           String?
  employerState          String?
  employerZipCode        String?
  monthlyIncome          Decimal? @db.Decimal(10, 2)
  yearsEmployed          Int?
  monthsEmployed         Int?
  additionalIncome       Decimal? @db.Decimal(10, 2)
  additionalIncomeSource String?

  // Relaciones de empleo
  employmentStatus EmploymentStatus? @relation(fields: [employmentStatusId], references: [id])
  occupation       Occupation?       @relation(fields: [occupationId], references: [id])

  // Empleo Anterior
  previousEmployer        String?
  previousEmployerPhone   String?
  previousJobTitle        String?
  previousEmployerAddress String?
  previousEmployerCity    String?
  previousEmployerState   String?
  previousEmployerZipCode String?
  previousMonthlyIncome   Decimal? @db.Decimal(10, 2)
  previousYearsEmployed   Int?
  previousMonthsEmployed  Int?

  // Información Bancaria
  bankName          String?
  bankAccountType   String?
  bankRoutingNumber String?
  bankAccountNumber String? // Encriptado
  yearsWithBank     Int?
  monthsWithBank    Int?

  // Historial de Crédito
  creditScore             Int?
  bankruptcyHistory       Boolean   @default(false)
  bankruptcyDate          DateTime?
  bankruptcyType          String?
  bankruptcyDischargeDate DateTime?
  repoHistory             Boolean   @default(false)
  repoDate                DateTime?
  foreclosureHistory      Boolean   @default(false)
  foreclosureDate         DateTime?

  // Deudas Mensuales
  currentMonthlyDebts Decimal? @db.Decimal(10, 2)
  alimonyChildSupport Decimal? @db.Decimal(10, 2)

  // Referencias Personales
  reference1Name       String?
  reference1Phone      String?
  reference1Relation   String?
  reference1Address    String?
  reference1YearsKnown Int?

  reference2Name       String?
  reference2Phone      String?
  reference2Relation   String?
  reference2Address    String?
  reference2YearsKnown Int?

  reference3Name       String?
  reference3Phone      String?
  reference3Relation   String?
  reference3Address    String?
  reference3YearsKnown Int?

  reference4Name       String?
  reference4Phone      String?
  reference4Relation   String?
  reference4Address    String?
  reference4YearsKnown Int?

  reference5Name       String?
  reference5Phone      String?
  reference5Relation   String?
  reference5Address    String?
  reference5YearsKnown Int?

  // Business Information (para aplicaciones comerciales)
  isBusinessBuyer         Boolean  @default(false)
  businessName            String?
  businessType            String?
  businessEIN             String?
  businessYearsInBusiness Int?
  businessAnnualRevenue   Decimal? @db.Decimal(12, 2)

  // OFAC / Compliance
  ofacCheckCompleted   Boolean   @default(false)
  ofacCheckDate        DateTime?
  ofacCheckResult      String?
  ofacNotes            String?
  identityVerified     Boolean   @default(false)
  identityVerifiedDate DateTime?
  identityVerifiedBy   String?

  // Metadatos
  source    String? // walk-in, phone, website, referral
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  dealsAsBuyer   Deal[] @relation("BuyerDeals")
  dealsAsCoBuyer Deal[] @relation("CoBuyerDeals")

  @@index([email])
  @@index([lastName, firstName])
  @@index([ssn])
  @@index([dateOfBirth])
  @@map("buyers")
}

// ============================================
// DEAL - Transacción/Aplicación de crédito vinculada a un vehículo y buyer
// ============================================
model Deal {
  id String @id @default(uuid())

  // ============================================
  // RELACIONES PRINCIPALES (Obligatorias)
  // ============================================
  buyerId   String
  vehicleId String? // Referencia al vehículo del inventario

  buyer   Buyer    @relation("BuyerDeals", fields: [buyerId], references: [id])
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id])

  // Co-Buyer (opcional)
  coBuyerId String?
  coBuyer   Buyer?  @relation("CoBuyerDeals", fields: [coBuyerId], references: [id])

  // ============================================
  // INFORMACIÓN DEL DEAL
  // ============================================
  dealNumber   String     @unique // Número único del deal (generado automáticamente)
  dealStatusId String
  dealStatus   DealStatus @relation(fields: [dealStatusId], references: [id])

  financeTypeId String? // cash, finance, lease
  financeType   FinanceType? @relation(fields: [financeTypeId], references: [id])

  // Fechas importantes
  dealDate     DateTime  @default(now()) // Fecha en que se inició el deal
  deliveryDate DateTime? // Fecha de entrega del vehículo
  fundedDate   DateTime? // Fecha en que se financió

  // ============================================
  // PRECIOS Y TÉRMINOS
  // ============================================
  // Precio del vehículo
  vehiclePrice Decimal  @db.Decimal(10, 2) // Precio de lista
  sellingPrice Decimal  @db.Decimal(10, 2) // Precio de venta final
  discount     Decimal? @db.Decimal(10, 2) // Descuento aplicado
  rebate       Decimal? @db.Decimal(10, 2) // Rebates del fabricante

  // Trade-In
  hasTradeIn         Boolean  @default(false)
  tradeInYear        Int?
  tradeInMake        String?
  tradeInModel       String?
  tradeInVin         String?
  tradeInMileage     Int?
  tradeInActualValue Decimal? @db.Decimal(10, 2) // Valor real del trade-in
  tradeInAllowance   Decimal? @db.Decimal(10, 2) // Lo que se le da al cliente
  tradeInPayoff      Decimal? @db.Decimal(10, 2) // Lo que se debe del trade-in
  tradeInLienHolder  String?
  tradeInEquity      Decimal? @db.Decimal(10, 2) // Calculado: allowance - payoff

  // Impuestos y Fees
  salesTax        Decimal? @db.Decimal(10, 2)
  docFee          Decimal? @db.Decimal(10, 2)
  titleFee        Decimal? @db.Decimal(10, 2)
  registrationFee Decimal? @db.Decimal(10, 2)
  otherFees       Decimal? @db.Decimal(10, 2)
  totalFees       Decimal? @db.Decimal(10, 2) // Total de fees

  // Totales
  totalCashPrice Decimal? @db.Decimal(10, 2) // Precio total si paga en efectivo
  downPayment    Decimal? @db.Decimal(10, 2) // Enganche
  amountFinanced Decimal? @db.Decimal(10, 2) // Monto a financiar

  // ============================================
  // TÉRMINOS DE FINANCIAMIENTO
  // ============================================
  apr             Decimal? @db.Decimal(5, 3) // Annual Percentage Rate
  term            Int? // Término en meses
  monthlyPayment  Decimal? @db.Decimal(10, 2)
  totalOfPayments Decimal? @db.Decimal(10, 2) // Total a pagar
  financeCharge   Decimal? @db.Decimal(10, 2) // Cargos financieros

  // Lender Information
  lenderName    String?
  lenderId      String? // ID del lender en el sistema
  lenderRate    Decimal? @db.Decimal(5, 3) // Rate que da el lender
  dealerReserve Decimal? @db.Decimal(5, 3) // Reserve/markup del dealer
  buyRate       Decimal? @db.Decimal(5, 3) // Buy rate (lender rate)
  sellRate      Decimal? @db.Decimal(5, 3) // Sell rate (to customer)

  // ============================================
  // PRODUCTOS ADICIONALES (F&I)
  // ============================================
  // Extended Warranty
  hasWarranty        Boolean  @default(false)
  warrantyProvider   String?
  warrantyCost       Decimal? @db.Decimal(10, 2)
  warrantyTerm       Int? // Meses o millas
  warrantyDeductible Decimal? @db.Decimal(10, 2)

  // GAP Insurance
  hasGap      Boolean  @default(false)
  gapProvider String?
  gapCost     Decimal? @db.Decimal(10, 2)

  // Maintenance Plan
  hasMaintenancePlan  Boolean  @default(false)
  maintenanceProvider String?
  maintenanceCost     Decimal? @db.Decimal(10, 2)

  // Other Products
  hasTheftProtection  Boolean  @default(false)
  theftProtectionCost Decimal? @db.Decimal(10, 2)

  hasPaintProtection  Boolean  @default(false)
  paintProtectionCost Decimal? @db.Decimal(10, 2)

  totalAftermarketProducts Decimal? @db.Decimal(10, 2) // Total de todos los productos

  // ============================================
  // CÁLCULOS AUTOMÁTICOS (LTV, PTI, DTI)
  // ============================================
  loanToValue     Decimal? @db.Decimal(5, 2) // LTV %
  paymentToIncome Decimal? @db.Decimal(5, 2) // PTI %
  debtToIncome    Decimal? @db.Decimal(5, 2) // DTI %

  // ============================================
  // APLICACIÓN DE CRÉDITO
  // ============================================
  // Consentimientos
  creditCheckConsent          Boolean   @default(false)
  creditCheckDate             DateTime?
  termsAccepted               Boolean   @default(false)
  termsAcceptedDate           DateTime?
  privacyPolicyAccepted       Boolean   @default(false)
  electronicDisclosureConsent Boolean   @default(false)

  // Credit Report
  creditReportPulled   Boolean   @default(false)
  creditReportDate     DateTime?
  creditReportProvider String? // Equifax, Experian, TransUnion
  creditScore          Int? // Score obtenido en este deal

  // Loan Application Status
  applicationStatus String? // draft, submitted, under_review, approved, denied, pending_info
  applicationDate   DateTime?
  approvalDate      DateTime?
  denialDate        DateTime?
  denialReason      String?
  stipulations      String? // Condiciones del lender

  // ============================================
  // INTEGRACIÓN CON PLATAFORMAS EXTERNAS
  // ============================================
  // DealerTrack
  dealertrackAppId         String?
  dealertrackStatus        String?
  dealertrackSubmittedDate DateTime?

  // RouteOne
  routeoneAppId         String?
  routeoneStatus        String?
  routeoneSubmittedDate DateTime?

  // CUDL
  cudlAppId         String?
  cudlStatus        String?
  cudlSubmittedDate DateTime?

  // ============================================
  // COMPLIANCE (Por transacción)
  // ============================================
  // Form 8300 - Cash transactions > $10,000
  cashTransactionOver10k Boolean   @default(false)
  form8300Filed          Boolean   @default(false)
  form8300FiledDate      DateTime?

  // Red Flags Rule
  redFlagsChecked Boolean @default(false)
  redFlagsNotes   String?

  // ============================================
  // LOAN DETAILS (para préstamos activos del buyer)
  // ============================================
  // Hasta 3 préstamos activos del buyer (snapshot al momento del deal)
  activeLoan1Type     String?
  activeLoan1Creditor String?
  activeLoan1Balance  Decimal? @db.Decimal(10, 2)
  activeLoan1Payment  Decimal? @db.Decimal(10, 2)

  activeLoan2Type     String?
  activeLoan2Creditor String?
  activeLoan2Balance  Decimal? @db.Decimal(10, 2)
  activeLoan2Payment  Decimal? @db.Decimal(10, 2)

  activeLoan3Type     String?
  activeLoan3Creditor String?
  activeLoan3Balance  Decimal? @db.Decimal(10, 2)
  activeLoan3Payment  Decimal? @db.Decimal(10, 2)

  // ============================================
  // PERSONAL DEL DEALER
  // ============================================
  salesPersonId    String? // Vendedor asignado
  salesManagerId   String? // Manager de ventas
  financeManagerId String? // F&I Manager

  // ============================================
  // NOTAS Y METADATOS
  // ============================================
  notes         String? // Notas generales
  internalNotes String? // Notas internas/privadas
  customerNotes String? // Notas del cliente

  source              String? // website, walk-in, phone, referral
  ipAddress           String?
  userAgent           String?
  applicationLanguage String? // en, es

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([buyerId])
  @@index([coBuyerId])
  @@index([vehicleId])
  @@index([dealNumber])
  @@index([dealStatusId])
  @@index([dealDate])
  @@index([dealertrackAppId])
  @@index([routeoneAppId])
  @@index([cudlAppId])
  @@index([salesPersonId])
  @@map("deals")
}

// ============================================
// TITLE - Título de propiedad del vehículo
// ============================================
model Title {
  id String @id @default(uuid())

  // Relación con el vehículo (un título pertenece a un vehículo)
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  // Información del Título
  titleNumber String  @unique // Número del título
  titleState  String // Estado que emitió el título (CA, TX, FL, etc.)
  titleType   String? // Original, Duplicate, Salvage, Rebuilt, etc.

  // Estado del título
  titleStatusId String
  titleStatus   TitleStatus @relation(fields: [titleStatusId], references: [id])

  // Brand del título (Clean, Salvage, Junk, Rebuilt, etc.)
  brandStatusId String?
  brandStatus   BrandStatus? @relation(fields: [brandStatusId], references: [id])

  // Fechas importantes
  titleIssueDate    DateTime? // Fecha de emisión del título
  titleReceivedDate DateTime? // Fecha en que se recibió el título
  titleSentDate     DateTime? // Fecha en que se envió el título

  // Información del propietario en el título
  ownerName    String? // Nombre del propietario según el título
  ownerAddress String?
  ownerCity    String?
  ownerState   String?
  ownerZipCode String?

  // Información del co-propietario (si aplica)
  coOwnerName    String?
  coOwnerAddress String?

  // Gravámenes (Liens)
  hasLien           Boolean   @default(false)
  lienHolder        String? // Nombre del acreedor
  lienHolderAddress String?
  lienHolderCity    String?
  lienHolderState   String?
  lienHolderZipCode String?
  lienAmount        Decimal?  @db.Decimal(10, 2)
  lienDate          DateTime?
  lienReleaseDate   DateTime?
  hasSecondLien     Boolean   @default(false)
  secondLienHolder  String?
  secondLienAmount  Decimal?  @db.Decimal(10, 2)

  // Odómetro
  odometerReading    Int? // Lectura del odómetro
  odometerDate       DateTime? // Fecha de la lectura
  odometerDisclosure String? // Actual, Not Actual, Exceeds Mechanical Limits
  odometerBrand      String? // TMU (True Mileage Unknown), EML (Exceeds Mechanical Limits)

  // Información del vehículo según el título
  titleVIN       String? // VIN según el título (para verificación)
  titleYear      Int?
  titleMake      String?
  titleModel     String?
  titleBodyStyle String?
  titleColor     String?

  // Transferencia
  isPendingTransfer Boolean   @default(false)
  transferDate      DateTime?
  transferredFrom   String? // Nombre del vendedor anterior
  transferredTo     String? // Nombre del nuevo comprador

  // Documentos relacionados - Relación con Media
  fileId String? // Archivo del título escaneado
  file   Media?  @relation("TitleFile", fields: [fileId], references: [id])

  lienReleaseFileId String?
  lienReleaseFile   Media?  @relation("TitleLienReleaseFile", fields: [lienReleaseFileId], references: [id])

  billOfSaleFileId String?
  billOfSaleFile   Media?  @relation("TitleBillOfSaleFile", fields: [billOfSaleFileId], references: [id])

  odometerStatementFileId String?
  odometerStatementFile   Media?  @relation("TitleOdometerStatementFile", fields: [odometerStatementFileId], references: [id])

  // Historial y verificación
  titleVerified     Boolean   @default(false)
  titleVerifiedDate DateTime?
  titleVerifiedBy   String? // Usuario que verificó

  isElectronic      Boolean @default(false) // Título electrónico
  electronicTitleId String? // ID del título electrónico

  // NMVTIS (National Motor Vehicle Title Information System)
  nmvtisChecked   Boolean   @default(false)
  nmvtisCheckDate DateTime?
  nmvtisStatus    String? // Clean, Salvage, Junk, etc.

  // Estado actual del título
  currentLocation    String? // Physical, Bank, DMV, Customer, etc.
  shippingTracking   String? // Tracking number si fue enviado
  expectedReturnDate DateTime?

  // Fees y costos
  titleFee            Decimal? @db.Decimal(10, 2)
  transferFee         Decimal? @db.Decimal(10, 2)
  liensatisfactionFee Decimal? @db.Decimal(10, 2)
  totalFees           Decimal? @db.Decimal(10, 2)

  // Notas
  notes         String?
  internalNotes String?

  // Compliance
  form8300Required Boolean @default(false) // Si la transacción fue > $10,000 en efectivo
  form8300Filed    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vehicleId])
  @@index([titleNumber])
  @@index([titleState])
  @@index([titleStatusId])
  @@index([brandStatusId])
  @@index([hasLien])
  @@index([isPendingTransfer])
  @@index([fileId])
  @@index([lienReleaseFileId])
  @@index([billOfSaleFileId])
  @@index([odometerStatementFileId])
  @@map("titles")
}

// ============================================
// MEDIA - Archivos multimedia (imágenes, videos, documentos)
// ============================================
model Media {
  id String @id @default(uuid())

  // Información del archivo
  filename String // Nombre original del archivo
  url      String // URL completa del archivo
  path     String? // Ruta relativa en el storage
  mimeType String // image/jpeg, image/png, video/mp4, application/pdf, etc.
  size     Int // Tamaño en bytes
  width    Int? // Ancho en píxeles (para imágenes/videos)
  height   Int? // Alto en píxeles (para imágenes/videos)
  duration Int? // Duración en segundos (para videos)

  // Metadata
  title       String?
  description String?
  alt         String? // Texto alternativo para imágenes

  // Tipo y contexto
  mediaType String // image, video, document, etc.
  category  String? // exterior, interior, engine, document, etc.

  // Storage
  storageProvider String? // local, s3, cloudinary, etc.
  storageBucket   String? // Nombre del bucket si aplica
  storageKey      String? // Key/identificador en el storage

  // Estado
  isPublic Boolean @default(true)
  isActive Boolean @default(true)

  // Relaciones con Vehicle
  vehicleId String?
  vehicle   Vehicle? @relation("VehicleGallery", fields: [vehicleId], references: [id], onDelete: Cascade)

  vehicleAsMain Vehicle? @relation("VehicleMainImage")

  // Relaciones con Title (documentos del título)
  titleAsFile                  Title[] @relation("TitleFile")
  titleAsLienReleaseFile       Title[] @relation("TitleLienReleaseFile")
  titleAsBillOfSaleFile        Title[] @relation("TitleBillOfSaleFile")
  titleAsOdometerStatementFile Title[] @relation("TitleOdometerStatementFile")

  // Relaciones con ExtraExpense (recibos)
  extraExpenseAsReceipt ExtraExpense[] @relation("ExtraExpenseReceipt")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vehicleId])
  @@index([mediaType])
  @@index([category])
  @@index([isActive])
  @@map("media")
}

// ============================================
// VEHICLE - Vehículo en inventario
// ============================================
model Vehicle {
  id String @id @default(uuid())

  // VIN y Stock
  vin         String  @unique
  stockNumber String? @unique

  // Año, Marca, Modelo, Trim
  year  Int
  make  String
  model String
  trim  String?

  // Detalles del vehículo
  mileage       Int?
  exteriorColor String?
  interiorColor String?

  // Tipos y condiciones (usando nomencladores)
  vehicleTypeId      String?
  bodyTypeId         String?
  fuelTypeId         String?
  driveTypeId        String?
  transmissionTypeId String?
  vehicleConditionId String?
  vehicleStatusId    String?
  sourceId           String?

  // Relaciones con nomencladores
  vehicleType      VehicleType?      @relation(fields: [vehicleTypeId], references: [id])
  bodyType         BodyType?         @relation(fields: [bodyTypeId], references: [id])
  fuelType         FuelType?         @relation(fields: [fuelTypeId], references: [id])
  driveType        DriveType?        @relation(fields: [driveTypeId], references: [id])
  transmissionType TransmissionType? @relation(fields: [transmissionTypeId], references: [id])
  vehicleCondition VehicleCondition? @relation(fields: [vehicleConditionId], references: [id])
  vehicleStatus    VehicleStatus?    @relation(fields: [vehicleStatusId], references: [id])
  source           VehicleSource?    @relation(fields: [sourceId], references: [id])

  // Precios
  costPrice Decimal? @db.Decimal(10, 2) // Costo del vehículo
  listPrice Decimal? @db.Decimal(10, 2) // Precio de lista
  salePrice Decimal? @db.Decimal(10, 2) // Precio de venta actual

  // Motor y especificaciones
  engine     String?
  cylinders  Int?
  doors      Int?
  passengers Int?

  // Información adicional
  description String?
  features    String? // JSON o texto con features

  // Imágenes - Relación con Media
  mainImageId String? @unique
  mainImage   Media?  @relation("VehicleMainImage", fields: [mainImageId], references: [id])
  gallery     Media[] @relation("VehicleGallery")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  deals         Deal[]
  titles        Title[] // Un vehículo puede tener múltiples títulos
  extraExpenses ExtraExpense[] // Gastos extras del vehículo

  @@index([vin])
  @@index([stockNumber])
  @@index([year, make, model])
  @@index([vehicleStatusId])
  @@index([mainImageId])
  @@index([sourceId])
  @@map("vehicles")
}

// ============================================
// EXTRA EXPENSE - Gastos extras del vehículo
// ============================================
model ExtraExpense {
  id String @id @default(uuid())

  /// Relación con el vehículo
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  // Información del gasto
  description String
  price       Decimal @db.Decimal(10, 2)

  // Recibo escaneado - Relación con Media
  receiptId String?
  receipt   Media?  @relation("ExtraExpenseReceipt", fields: [receiptId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vehicleId])
  @@index([receiptId])
  @@map("extra_expenses")
}
